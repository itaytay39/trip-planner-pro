<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הטיולים שלי</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <style>
        /* Base Styles & Typography (Inter font as requested, or similar sans-serif) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --color-primary: #4A90E2; /* Vibrant blue */
            --color-secondary: #F5A623; /* Energetic orange */
            --color-background: #F9F9F9; /* Light grey */
            --color-card: #FFFFFF; /* White */
            --color-text: #333333; /* Dark grey */
            --color-light-text: #666666; /* Medium grey */
            --color-accent: #7ED321; /* Fresh green */
            --color-border: #E0E0E0; /* Light grey */
            --color-shadow: rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text);
            direction: rtl; /* Right-to-left for Hebrew */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }

        /* Responsive Layout */
        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 100vw; /* Ensure fluid width */
            overflow: hidden; /* Hide overflow */
        }

        /* Header */
        .header {
            padding: 15px;
            padding-top: 50px; /* Space for status bar */
            background-color: var(--color-card);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px var(--color-shadow);
        }

        .header-title {
            font-size: 22px;
            font-weight: bold;
            color: var(--color-text);
            flex-grow: 1;
            flex-shrink: 1;
            margin-inline-end: 10px;
        }

        .header-button {
            background-color: var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: var(--color-card);
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
        }
        .header-button:active {
            transform: scale(0.95);
        }

        /* Trip Picker */
        .trip-picker-container {
            position: relative;
            z-index: 10;
        }

        .trip-picker {
            background-color: transparent;
            border: none;
            font-size: 17px;
            color: var(--color-primary);
            font-weight: 500;
            padding: 5px;
            border-radius: 8px;
            cursor: pointer;
            -webkit-appearance: none; /* Remove default dropdown arrow for custom styling */
            -moz-appearance: none;
            appearance: none;
            padding-inline-end: 25px; /* Space for custom arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234A90E2'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); /* Custom arrow */
            background-repeat: no-repeat;
            background-position: left 8px center; /* Position custom arrow */
            width: 150px; /* Initial width */
            text-align: end;
        }
        @media (max-width: 480px) {
            .trip-picker {
                width: 120px;
                font-size: 15px;
            }
        }


        /* User ID */
        .user-id-container {
            background-color: var(--color-card);
            padding: 8px 15px;
            border-bottom: 1px solid var(--color-border);
            text-align: center;
        }
        .user-id-text {
            font-size: 13px;
            color: var(--color-light-text);
        }

        /* Navigation Tabs */
        .nav-container {
            display: flex;
            justify-content: space-around;
            background-color: var(--color-card);
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border);
            box-shadow: 0 2px 6px var(--color-shadow);
            flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
        }

        .nav-button {
            padding: 8px 10px;
            border-radius: 20px;
            background-color: transparent;
            flex: 1; /* Distribute space evenly */
            text-align: center;
            margin: 5px; /* Add margin for spacing */
            transition: background-color 0.2s ease;
        }

        .nav-button-active {
            background-color: var(--color-primary);
        }

        .nav-button-text {
            color: var(--color-light-text);
            font-size: 17px;
            font-weight: 500;
        }

        .nav-button-text-active {
            color: var(--color-card);
        }
        @media (max-width: 480px) {
            .nav-button {
                flex-basis: 45%; /* Two buttons per row on small screens */
            }
            .nav-button-text {
                font-size: 15px;
            }
        }


        /* Content Area & Sections */
        .content-area {
            flex: 1;
            padding: 15px;
            overflow-y: auto; /* Enable scrolling for content */
        }

        .section {
            background-color: var(--color-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px var(--color-shadow);
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .section-subtitle {
            font-size: 15px;
            color: var(--color-light-text);
            margin-bottom: 15px;
        }

        .footnote-text {
            font-size: 12px;
            color: var(--color-light-text);
            margin-top: 10px;
            text-align: center;
        }

        /* Loading / Empty State */
        .loading-container, .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--color-background);
            padding: 20px;
            text-align: center;
        }
        .loading-text {
            margin-top: 10px;
            font-size: 17px;
            color: var(--color-text);
        }
        .empty-state-text {
            font-size: 20px;
            color: var(--color-light-text);
            margin-bottom: 20px;
        }

        /* Buttons (General) */
        .add-button, .modal-button {
            background-color: var(--color-accent);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            text-decoration: none;
            color: var(--color-card);
            font-size: 17px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .add-button:active {
            transform: scale(0.95);
        }

        .modal-button.cancel {
            background-color: var(--color-light-text);
            margin-top: 10px;
        }


        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--color-card);
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: var(--color-text);
        }

        .input {
            border: 1px solid var(--color-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 17px;
            color: var(--color-text);
            background-color: var(--color-background);
            width: 100%;
            box-sizing: border-box; /* Include padding in width */
        }
        
        .picker-select {
            border: 1px solid var(--color-border);
            border-radius: 10px;
            margin-bottom: 15px;
            color: var(--color-text);
            background-color: var(--color-background);
            height: 50px;
            width: 100%;
            padding: 0 10px;
            font-size: 17px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666666'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); /* Custom arrow */
            background-repeat: no-repeat;
            background-position: left 10px center;
        }

        .new-category-input-container {
            margin-bottom: 15px;
        }

        .radio-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--color-border);
        }

        .radio-button {
            flex: 1;
            padding: 12px;
            text-align: center;
            background-color: var(--color-background);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .radio-button-selected {
            background-color: var(--color-primary);
        }

        .radio-button-text {
            color: var(--color-light-text);
            font-size: 15px;
            font-weight: 500;
        }
        .radio-button-selected .radio-button-text {
            color: var(--color-card);
        }


        /* Itinerary Styles */
        .day-tabs-container {
            margin-bottom: 15px;
            display: flex;
            overflow-x: auto; /* Enable horizontal scrolling */
            padding-bottom: 10px; /* Space for scrollbar */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .day-tabs-container::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .day-tabs-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .day-tab {
            padding: 10px 15px;
            border-radius: 25px;
            background-color: var(--color-background);
            margin-inline-end: 8px;
            box-shadow: 0 1px 3px var(--color-shadow);
            flex-shrink: 0; /* Prevent shrinking */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 120px; /* Ensure minimum width for readability */
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .day-tab:active {
            transform: scale(0.98);
        }

        .day-tab-selected {
            background-color: var(--color-primary);
        }

        .day-tab-text {
            color: var(--color-text);
            font-size: 13px;
            font-weight: 500;
            text-align: center;
        }
        .day-tab-selected .day-tab-text {
            color: var(--color-card);
        }

        .day-tab-full-text {
            font-size: 15px; /* Slightly larger for selected */
        }

        .day-details-card {
            background-color: var(--color-background);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px var(--color-shadow);
        }

        .day-details-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--color-text);
        }

        .weather-info {
            font-size: 16px;
            color: var(--color-light-text);
            margin-bottom: 10px;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-border);
            flex-wrap: wrap; /* Allow content to wrap */
        }

        .activity-time {
            font-size: 15px;
            font-weight: bold;
            margin-inline-end: 12px;
            color: var(--color-primary);
            min-width: 55px; /* Consistent width for time */
            text-align: end;
        }

        .activity-description {
            flex: 1;
            font-size: 17px;
            color: var(--color-text);
            line-height: 1.4;
        }

        .book-ticket-button {
            background-color: var(--color-secondary);
            padding: 6px 12px;
            border-radius: 8px;
            margin-top: 5px;
            margin-inline-start: auto; /* Push to left (RTL) */
            text-decoration: none;
            color: var(--color-card);
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        .book-ticket-button:active {
            transform: scale(0.98);
        }

        /* Map Styles */
        .map-container {
            height: 250px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--color-border);
            box-shadow: 0 2px 6px var(--color-shadow);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .recommendation-card {
            background-color: var(--color-background);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px var(--color-shadow);
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .recommendation-card:active {
            transform: scale(0.98);
        }

        .recommendation-name {
            font-size: 17px;
            font-weight: 500;
            color: var(--color-text);
        }

        .recommendation-details {
            font-size: 13px;
            color: var(--color-light-text);
        }

        /* Budget Styles */
        .budget-summary-card {
            background-color: var(--color-background);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px var(--color-shadow);
        }

        .budget-summary-text {
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .budget-breakdown {
            margin-top: 15px;
            border-top: 1px solid var(--color-border);
            padding-top: 15px;
        }

        .budget-breakdown-text {
            font-size: 15px;
            color: var(--color-light-text);
            margin-bottom: 5px;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--color-border);
            flex-wrap: wrap; /* Allow text to wrap */
        }

        .expense-description {
            font-size: 17px;
            color: var(--color-text);
            flex: 1;
            margin-inline-end: 10px;
        }

        .expense-amount {
            font-size: 17px;
            font-weight: bold;
            color: var(--color-primary);
            margin-inline-end: 5px;
        }

        .expense-category {
            font-size: 13px;
            color: var(--color-light-text);
        }

        /* Packing List Styles */
        .packing-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .packing-item-text {
            font-size: 17px;
            color: var(--color-text);
            margin-inline-start: 10px;
            flex: 1;
        }

        .packing-item-text-packed {
            text-decoration: line-through;
            color: var(--color-light-text);
        }

        /* Debt Styles */
        .debt-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--color-border);
            flex-wrap: wrap;
        }

        .debt-description {
            font-size: 17px;
            color: var(--color-text);
            flex: 1;
            margin-inline-end: 10px;
        }

        .debt-amount {
            font-size: 17px;
            font-weight: bold;
            color: var(--color-secondary);
            margin-inline-end: 5px;
        }

        .debt-status-button {
            padding: 8px 12px;
            border-radius: 10px;
            background-color: var(--color-light-text);
            margin-inline-start: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .debt-status-button:active {
            transform: scale(0.98);
        }

        .debt-status-button-settled {
            background-color: var(--color-accent);
        }

        .debt-status-button-text {
            color: var(--color-card);
            font-size: 12px;
            font-weight: bold;
        }

        /* Info Card */
        .info-card {
            background-color: var(--color-background);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 1px 3px var(--color-shadow);
        }

        .info-text {
            font-size: 17px;
            color: var(--color-text);
            line-height: 1.5;
        }
        
        /* General Modals (for Add Trip, Add Expense, etc.) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-show {
            display: flex;
        }

        .modal-content-dialog {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            left: 10px;
            top: 5px;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* Specific overrides for Picker to look good */
        select.picker-select {
            -webkit-appearance: menulist-button; /* Restore default appearance for better dropdown behavior */
            background-image: none; /* Remove custom arrow as browser handles it */
            padding-inline-end: 10px; /* Adjust padding */
        }
        
        /* Specific styling for the main Trip Picker */
        .trip-picker {
             padding-inline-end: 10px; /* Adjust padding */
             background-image: none; /* No custom arrow for this one */
        }


    </style>
</head>
<body>
    <div class="container" id="app-container">
        <!-- Loading State -->
        <div class="loading-container" id="loading-state">
            <div class="spinner"></div> <!-- Simple spinner CSS for loading -->
            <p class="loading-text">טוען טיולים ומתחבר ל-Firebase...</p>
        </div>

        <!-- Empty State (No Trips) -->
        <div class="empty-state" id="empty-state" style="display: none;">
            <p class="empty-state-text">אין טיולים מוגדרים. התחל עכשיו!</p>
            <button class="add-button" onclick="showNewTripModal()">הוסף טיול ראשון</button>
        </div>

        <!-- Main App Content -->
        <div id="main-app-content" style="display: none;">
            <!-- Header with Trip Picker -->
            <div class="header">
                <h1 class="header-title">הטיולים שלי</h1>
                <select class="trip-picker" id="trip-picker" onchange="handleTripPickerChange()">
                    <!-- Options will be populated by JS -->
                </select>
                <a href="#" class="header-button" onclick="showNewTripModal()">+</a>
            </div>

            <!-- User ID Display -->
            <div class="user-id-container">
                <p class="user-id-text" id="user-id-display">מזהה משתמש: טוען...</p>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-container">
                <button class="nav-button" data-screen="itinerary" onclick="navigateTo('itinerary')">
                    <span class="nav-button-text">מסלול</span>
                </button>
                <button class="nav-button" data-screen="budget" onclick="navigateTo('budget')">
                    <span class="nav-button-text">תקציב</span>
                </button>
                <button class="nav-button" data-screen="packing" onclick="navigateTo('packing')">
                    <span class="nav-button-text">ציוד</span>
                </button>
                <button class="nav-button" data-screen="debts" onclick="navigateTo('debts')">
                    <span class="nav-button-text">חובות</span>
                </button>
                <button class="nav-button" data-screen="whatsNext" onclick="navigateTo('whatsNext')">
                    <span class="nav-button-text">מה הלאה?</span>
                </button>
            </div>

            <!-- Main Content Area -->
            <div class="content-area">
                <!-- Itinerary Screen -->
                <div class="section" id="itinerary-screen">
                    <h2 class="section-title">מסלול טיול - <span id="itinerary-trip-name"></span></h2>
                    <p class="section-subtitle"><span id="itinerary-trip-dates"></span></p>

                    <div class="day-tabs-container" id="day-tabs-container">
                        <!-- Day tabs will be populated by JS -->
                    </div>

                    <div class="day-details-card" id="day-details-card">
                        <h3 class="day-details-title" id="current-day-title"></h3>
                        <p class="weather-info" id="weather-info"></p>
                        <div id="activities-list">
                            <!-- Activities will be populated by JS -->
                        </div>
                        <button class="add-button" onclick="addItineraryActivity()">הוסף פעילות</button>
                    </div>

                    <div class="map-container">
                        <div id="map"></div>
                    </div>

                    <p class="section-subtitle">המלצות בסביבה (מבוססות GPS):</p>
                    <div id="recommendations-list">
                        <!-- Recommendations will be populated by JS -->
                    </div>
                    <p class="footnote-text">*המלצות בזמן אמת דורשות הפעלת GPS וחיבור ל-Google Places API.</p>
                </div>

                <!-- Budget Screen -->
                <div class="section" id="budget-screen" style="display: none;">
                    <h2 class="section-title">תקציב - <span id="budget-trip-name"></span></h2>
                    <div class="budget-summary-card">
                        <p class="budget-summary-text">תקציב כולל: $<span id="budget-total"></span></p>
                        <p class="budget-summary-text">הוצאות: $<span id="budget-expenses"></span></p>
                        <p class="budget-summary-text">יתרה: $<span id="budget-remaining"></span></p>
                        <div class="budget-breakdown">
                            <p class="budget-breakdown-text">אישי: $<span id="budget-personal"></span> (הוצא: $<span id="budget-personal-spent"></span>)</p>
                            <p class="budget-breakdown-text">משותף: $<span id="budget-shared"></span> (הוצא: $<span id="budget-shared-spent"></span>)</p>
                        </div>
                    </div>
                    <button class="add-button" onclick="showAddExpenseModal()">הוסף הוצאה</button>
                    <p class="section-subtitle">הוצאות אחרונות:</p>
                    <div id="expenses-list">
                        <!-- Expenses will be populated by JS -->
                    </div>
                </div>

                <!-- Packing List Screen -->
                <div class="section" id="packing-screen" style="display: none;">
                    <h2 class="section-title">רשימת ציוד - <span id="packing-trip-name"></span></h2>
                    <p class="section-subtitle">סמן פריטים שארוזים</p>
                    <div id="packing-list">
                        <!-- Packing items will be populated by JS -->
                    </div>
                    <button class="add-button" onclick="showAddPackingItemModal()">הוסף פריט</button>
                </div>

                <!-- Debts Screen -->
                <div class="section" id="debts-screen" style="display: none;">
                    <h2 class="section-title">תזכורות חובות - <span id="debts-trip-name"></span></h2>
                    <p class="section-subtitle">עקוב אחר מי חייב למי</p>
                    <div id="debts-list">
                        <!-- Debts will be populated by JS -->
                    </div>
                    <button class="add-button" onclick="showAddDebtModal()">הוסף חוב חדש</button>
                </div>

                <!-- What's Next Screen -->
                <div class="section" id="whatsNext-screen" style="display: none;">
                    <h2 class="section-title">מה הלאה? המלצות חכמות</h2>
                    <p class="section-subtitle">האפליקציה תציע כאן פעילויות מומלצות בהתבסס על מיקומך, שעת היום ומסלול הטיול.</p>
                    <div class="info-card">
                        <p class="info-text">
                            כאן יוצגו הצעות כמו:
                            <br>• מסעדות בקרבת מקום לארוחת צהריים.
                            <br>• אטרקציה קרובה שטרם ביקרתם בה.
                            <br>• תחבורה מומלצת ליעד הבא במסלול.
                            <br>• • אירועים מיוחדים המתקיימים היום באזורך.
                        </p>
                    </div>
                    <p class="footnote-text">*פיצ'ר זה יופעל במלואו עם GPS פעיל וגישה לנתוני מיקום.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- New Trip Modal -->
    <div id="new-trip-modal" class="modal">
        <div class="modal-overlay">
            <div class="modal-content-dialog">
                <span class="close-button" onclick="hideNewTripModal()">&times;</span>
                <h3 class="modal-title">הוסף טיול חדש</h3>
                <input type="text" class="input" id="new-trip-name" placeholder="שם הטיול (לדוגמה: טיול לאירופה)">
                <input type="text" class="input" id="new-trip-dates" placeholder="תאריכים (לדוגמה: 1-15 באוגוסט)">
                <input type="number" class="input" id="new-trip-budget-total" placeholder="תקציב כולל (בדולרים)">
                <button class="modal-button" onclick="addNewTrip()">שמור טיול</button>
                <button class="modal-button cancel" onclick="hideNewTripModal()">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="add-expense-modal" class="modal">
        <div class="modal-overlay">
            <div class="modal-content-dialog">
                <span class="close-button" onclick="hideAddExpenseModal()">&times;</span>
                <h3 class="modal-title">הוסף הוצאה חדשה</h3>
                <input type="text" class="input" id="new-expense-description" placeholder="תיאור הוצאה">
                <input type="number" class="input" id="new-expense-amount" placeholder="סכום (דולרים)">
                <select class="picker-select" id="new-expense-category">
                    <option value="">בחר קטגוריה</option>
                </select>
                <div class="new-category-input-container" id="new-category-input-container" style="display: none;">
                    <input type="text" class="input" id="new-category-name" placeholder="שם קטגוריה חדשה">
                    <button class="modal-button" onclick="addNewCategory()">שמור קטגוריה</button>
                </div>
                <div class="radio-container">
                    <button class="radio-button" data-type="shared" onclick="setNewExpenseType('shared')">
                        <span class="radio-button-text">הוצאה משותפת</span>
                    </button>
                    <button class="radio-button" data-type="personal" onclick="setNewExpenseType('personal')">
                        <span class="radio-button-text">הוצאה אישית</span>
                    </button>
                </div>
                <button class="modal-button" onclick="addExpense()">הוסף</button>
                <button class="modal-button cancel" onclick="hideAddExpenseModal()">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Add Packing Item Modal -->
    <div id="add-packing-item-modal" class="modal">
        <div class="modal-overlay">
            <div class="modal-content-dialog">
                <span class="close-button" onclick="hideAddPackingItemModal()">&times;</span>
                <h3 class="modal-title">הוסף פריט חדש לרשימה</h3>
                <input type="text" class="input" id="new-packing-item" placeholder="שם פריט">
                <button class="modal-button" onclick="addPackingItem()">הוסף</button>
                <button class="modal-button cancel" onclick="hideAddPackingItemModal()">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Add Debt Modal -->
    <div id="add-debt-modal" class="modal">
        <div class="modal-overlay">
            <div class="modal-content-dialog">
                <span class="close-button" onclick="hideAddDebtModal()">&times;</span>
                <h3 class="modal-title">הוסף תזכורת חוב</h3>
                <input type="text" class="input" id="new-debt-description" placeholder="תיאור (לדוגמה: מקדמה למלון)">
                <input type="number" class="input" id="new-debt-amount" placeholder="סכום (דולרים)">
                <input type="text" class="input" id="new-debt-friend" placeholder="שם החבר (לדוגמה: דני)">
                <button class="modal-button" onclick="addDebt()">הוסף</button>
                <button class="modal-button cancel" onclick="hideAddDebtModal()">ביטול</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrnqOiCt-0DizYiXxb73BDGDDLUn1Zdds&libraries=places&callback=initMap"></script>
    <script>
        // --- החלק החשוב ביותר: הגדרות Firebase שלך ---
        // 1. קונפיגורציית Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB11HU1nmZwjY5sGQjyyWud_stNoqEwsi4",
            authDomain: "mytravelapp2025.firebaseapp.com",
            projectId: "mytravelapp2025",
            storageBucket: "mytravelapp2025.firebasestorage.app",
            messagingSenderId: "287931178675",
            appId: "1:287931178675:web:5a8ea129b9e86727f45ac6"
        };
        // --- סוף חלק ההגדרות ---

        let app;
        let db;
        let auth;
        let userId = null;
        let currentTrips = [];
        let selectedTrip = null;
        let selectedDayIndex = 0;
        let newExpenseType = 'shared'; // Default for new expense

        // Firebase Initialization
        if (firebaseConfig && Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore(); 
            auth = firebase.auth();
            console.log("Firebase initialized successfully.");
        } else {
            console.error("Firebase config is missing or empty. Firebase will not be initialized.");
            document.getElementById('loading-state').innerHTML = `<p class="loading-text" style="color: red;">שגיאת Firebase: קונפיגורציה חסרה. אנא מלא את firebaseConfig בקוד.</p>`;
        }

        // --- Core App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            if (auth && db) {
                auth.onAuthStateChanged(user => { // Corrected: auth.onAuthStateChanged
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Authenticated User:", userId);
                        loadTrips();
                    } else {
                        console.log("No user, signing in anonymously...");
                        auth.signInAnonymously() // Corrected: auth.signInAnonymously()
                            .then(userCredential => {
                                userId = userCredential.user.uid;
                                console.log("Signed in anonymously:", userId);
                                loadTrips();
                            })
                            .catch(error => {
                                console.error("Firebase Anonymous Auth Error:", error);
                                alert("שגיאת התחברות ל-Firebase: לא ניתן היה להתחבר. אנא בדוק את החיבור שלך.");
                                document.getElementById('loading-state').innerHTML = `<p class="loading-text" style="color: red;">שגיאת התחברות: לא ניתן היה להתחבר ל-Firebase.</p>`;
                            });
                    }
                });
            } else {
                document.getElementById('loading-state').innerHTML = `<p class="loading-text" style="color: red;">שגיאת Firebase: לא אותחל. אנא בדוק את הקונפיגורציה שלך ב-JS.</p>`;
                document.getElementById('main-app-content').style.display = 'none';
                document.getElementById('empty-state').style.display = 'flex';
            }
        });

        async function loadTrips() {
            document.getElementById('user-id-display').textContent = `מזהה משתמש: ${userId}`;
            const collectionPath = `artifacts/pwa-travel-app/users/${userId}/trips`;
            const userDocRef = db.collection(collectionPath).doc('userTrips');
            try {
                const docSnap = await userDocRef.get();
                if (docSnap.exists && docSnap.data().allTrips) {
                    currentTrips = docSnap.data().allTrips;
                    console.log("Trips loaded from Firestore.");
                } else {
                    console.log("No trips found, initializing with mock data.");
                    currentTrips = [
                        {
                            id: 'trip-1',
                            name: 'טיול אמריקה - בולטימור למיין',
                            dates: '14 ביולי - 21 ביולי 2025',
                            budget: {
                                total: 2500, personalTotal: 1000, sharedTotal: 1500, expenses: [],
                                categories: ['לינה', 'תחבורה', 'אוכל', 'אטרקציות', 'קניות', 'שונות'],
                            },
                            packingList: [
                                { id: 'pack-1', item: 'דרכון', packed: false }, { id: 'pack-2', item: 'כרטיסי טיסה', packed: false },
                                { id: 'pack-3', item: 'מטען נייד', packed: false }, { id: 'pack-4', item: 'כבל טעינה', packed: false },
                                { id: 'pack-5', item: 'ראש טעינה אוניברסלי', packed: false }, { id: 'pack-6', item: 'דוחה יתושים', packed: false },
                                { id: 'pack-7', item: 'בגדים ל-9 ימים', packed: false }, { id: 'pack-8', item: 'נעלי הליכה נוחות', packed: false },
                                { id: 'pack-9', item: 'בגד ים', packed: false }, { id: 'pack-10', item: 'משקפי שמש', packed: false },
                                { id: 'pack-11', item: 'כובע', packed: false }, { id: 'pack-12', item: 'קרם הגנה', packed: false },
                                { id: 'pack-13', item: 'מצלמה', packed: false }, { id: 'pack-14', item: 'תרופות אישיות', packed: false },
                                { id: 'pack-15', item: 'מתאם לשקע אמריקאי', packed: false },
                            ],
                            debts: [],
                            itinerary: [
                                {
                                    id: 'day-1', date: '14 ביולי', location: 'אוגוסטה, מיין', activities: [
                                        { id: 'act-1-1', time: '05:00', description: 'יציאה מבולטימור לכיוון ניו המפשייר', coords: { latitude: 39.290385, longitude: -76.612190 } },
                                        { id: 'act-1-2', time: '12:30', description: 'עצירה בפורטסמות\', ניו המפשייר', coords: { latitude: 43.0784, longitude: -70.7628 } },
                                    ],
                                },
                                {
                                    id: 'day-2', date: '15 ביולי', location: 'בר הרבור, מיין', activities: [
                                        { id: 'act-2-1', time: '09:00', description: 'טיול באוגוסטה - קפיטול, גנים בוטניים', coords: { latitude: 44.3105, longitude: -69.7795 } },
                                        { id: 'act-2-2', time: '14:00', description: 'נסיעה לבר הרבור', coords: { latitude: 44.3876, longitude: -68.2039 } },
                                    ],
                                },
                            ],
                        },
                        {
                            id: 'trip-2',
                            name: 'טיול אמריקה - ניו יורק',
                            dates: '13 ביולי - 16 ביולי 2025',
                            budget: {
                                total: 1500, personalTotal: 700, sharedTotal: 800, expenses: [],
                                categories: ['לינה', 'תחבורה', 'אוכל', 'אטרקציות', 'קניות', 'שונות'],
                            },
                            packingList: [
                                { id: 'pack-ny-1', item: 'כרטיס מטרו', packed: false },
                                { id: 'pack-ny-2', item: 'נעלי הליכה נוחות במיוחד', packed: false },
                                { id: 'pack-ny-3', item: 'מטריה קטנה', packed: false },
                            ],
                            debts: [],
                            itinerary: [
                                {
                                    id: 'ny-day-1', date: '13 ביולי', location: 'ניו יורק', activities: [
                                        { id: 'ny-act-1-1', time: 'בוקר', description: 'ארוחת בוקר קלה: בייגל כשר', coords: { latitude: 40.7816, longitude: -73.9782 } },
                                        { id: 'ny-act-1-2', time: 'בוקר', description: 'הליכה למוזיאון המטרופוליטן לאמנות', coords: { latitude: 40.7794, longitude: -73.9632 } },
                                    ],
                                },
                                {
                                    id: 'ny-day-2', date: '14 ביולי', location: 'ניו יורק', activities: [
                                        { id: 'ny-act-2-1', time: 'בוקר', description: 'הליכה למוזיאון מומה (MoMA)', coords: { latitude: 40.7614, longitude: -73.9776 } },
                                        { id: 'ny-act-2-2', time: 'בוקר', description: 'ביקור ברוקפלר סנטר', coords: { latitude: 40.7587, longitude: -73.9787 } },
                                    ],
                                },
                            ],
                        },
                    ];
                    await userDocRef.set({ allTrips: currentTrips });
                }
                updateTripPicker();
                showMainAppContent();
            } catch (error) {
                console.error("Error loading trips from Firestore:", error);
                alert("שגיאת טעינה: לא ניתן היה לטעון את נתוני הטיולים. אנא בדוק את חיבור האינטרנט וכללי האבטחה של Firebase.");
                showEmptyState(); // Show empty state on load error
            } finally {
                document.getElementById('loading-state').style.display = 'none';
            }
        }

        async function saveTrips() {
            if (userId && db && currentTrips.length > 0) {
                const collectionPath = `artifacts/pwa-travel-app/users/${userId}/trips`;
                const userDocRef = db.collection(collectionPath).doc('userTrips');
                try {
                    await userDocRef.set({ allTrips: currentTrips });
                    console.log("Trips saved to Firestore.");
                } catch (error) {
                    console.error("Error saving trips to Firestore:", error);
                    alert("שגיאת שמירה: לא ניתן היה לשמור את נתוני הטיולים.");
                }
            }
        }

        let saveDebounceTimer;
        function debounceSave() {
            clearTimeout(saveDebounceTimer);
            saveDebounceTimer = setTimeout(saveTrips, 1000); // Save 1 second after last change
        }

        function showLoadingState() {
            document.getElementById('loading-state').style.display = 'flex';
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('main-app-content').style.display = 'none';
        }

        function showEmptyState() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('empty-state').style.display = 'flex';
            document.getElementById('main-app-content').style.display = 'none';
        }

        function showMainAppContent() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('main-app-content').style.display = 'flex';
            renderScreen(); // Initial render of the selected screen
        }

        function updateTripPicker() {
            const picker = document.getElementById('trip-picker');
            picker.innerHTML = ''; // Clear existing options
            if (currentTrips.length === 0) {
                const option = document.createElement('option');
                option.value = 'no_trips';
                option.textContent = 'אין טיולים';
                picker.appendChild(option);
                picker.disabled = true; // Disable picker if no trips
                return;
            } else {
                picker.disabled = false;
            }

            currentTrips.forEach(trip => {
                const option = document.createElement('option');
                option.value = trip.id;
                option.textContent = trip.name;
                picker.appendChild(option);
            });
            picker.value = selectedTrip ? selectedTrip.id : currentTrips[0].id;
            selectedTrip = currentTrips.find(t => t.id === picker.value);
            renderScreen(); // Re-render after picker update
        }

        function handleTripPickerChange() {
            const picker = document.getElementById('trip-picker');
            if (picker.value === 'new_trip') {
                showNewTripModal();
            } else {
                selectedTrip = currentTrips.find(trip => trip.id === picker.value);
                selectedDayIndex = 0; // Reset day index on trip change
                renderScreen();
            }
        }

        function navigateTo(screen) {
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('nav-button-active');
                btn.querySelector('.nav-button-text').classList.remove('nav-button-text-active');
            });
            document.querySelector(`.nav-button[data-screen="${screen}"]`).classList.add('nav-button-active');
            document.querySelector(`.nav-button[data-screen="${screen}"] .nav-button-text`).classList.add('nav-button-text-active');

            document.getElementById('itinerary-screen').style.display = 'none';
            document.getElementById('budget-screen').style.display = 'none';
            document.getElementById('packing-screen').style.display = 'none';
            document.getElementById('debts-screen').style.display = 'none';
            document.getElementById('whatsNext-screen').style.display = 'none';

            document.getElementById(`${screen}-screen`).style.display = 'block';
            renderScreen(screen); // Render the new screen
        }

        function renderScreen(screen = currentScreen) {
            if (!selectedTrip) return;

            // Update Header
            document.getElementById('itinerary-trip-name').textContent = selectedTrip.name;
            document.getElementById('itinerary-trip-dates').textContent = selectedTrip.dates;
            document.getElementById('budget-trip-name').textContent = selectedTrip.name;
            document.getElementById('packing-trip-name').textContent = selectedTrip.name;
            document.getElementById('debts-trip-name').textContent = selectedTrip.name;

            // Render specific screen content
            if (screen === 'itinerary') {
                renderItinerary();
            } else if (screen === 'budget') {
                renderBudget();
            } else if (screen === 'packing') {
                renderPackingList();
            } else if (screen === 'debts') {
                renderDebts();
            } else if (screen === 'whatsNext') {
                // No dynamic rendering needed here, just the static content
            }
        }

        // --- Itinerary Functions ---
        let map; // Google Map instance
        let markers = []; // Store map markers

        window.initMap = function() {
            console.log("Google Maps API callback triggered.");
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                if (document.getElementById('itinerary-screen').style.display === 'block') {
                    renderItinerary();
                }
            } else {
                document.addEventListener('DOMContentLoaded', () => {
                    if (document.getElementById('itinerary-screen').style.display === 'block') {
                        renderItinerary();
                    }
                });
            }
        };

        function renderItinerary() {
            if (!selectedTrip || !selectedTrip.itinerary) return;

            const dayTabsContainer = document.getElementById('day-tabs-container');
            dayTabsContainer.innerHTML = '';
            selectedTrip.itinerary.forEach((day, index) => {
                const button = document.createElement('button');
                button.className = `day-tab ${index === selectedDayIndex ? 'day-tab-selected' : ''}`;
                button.innerHTML = `<span class="day-tab-text">יום ${index + 1}: ${day.date} - ${day.location}</span>`;
                button.onclick = () => {
                    selectedDayIndex = index;
                    renderItinerary();
                };
                dayTabsContainer.appendChild(button);
            });

            const currentDay = selectedTrip.itinerary[selectedDayIndex];
            if (!currentDay) return;

            document.getElementById('current-day-title').textContent = `${currentDay.date} - ${currentDay.location}`;
            document.getElementById('weather-info').textContent = `מזג אוויר: ${getWeatherForLocation(currentDay.location)}`;

            const activitiesList = document.getElementById('activities-list');
            activitiesList.innerHTML = '';
            currentDay.activities.forEach(activity => {
                const div = document.createElement('div');
                div.className = 'activity-item';
                div.innerHTML = `
                    <span class="activity-time">${activity.time}</span>
                    <span class="activity-description">${activity.description}</span>
                    ${(activity.description.includes('מוזיאון') || activity.description.includes('שייט') || activity.description.includes('פארק')) ?
                    `<a href="#" class="book-ticket-button" onclick="alert('הזמנת כרטיסים: פונקציונליות זו תנווט לאתר חיצוני להזמנת כרטיסים עבור: ${activity.description}')">הזמן כרטיסים</a>` : ''}
                `;
                activitiesList.appendChild(div);
            });

            // Google Maps Rendering Logic
            const mapContainer = document.getElementById('map');
            if (typeof google !== 'undefined' && google.maps) {
                if (!map) {
                    map = new google.maps.Map(mapContainer, {
                        center: { lat: currentDay.activities[0]?.coords?.latitude || 40.7580, lng: currentDay.activities[0]?.coords?.longitude || -73.9855 },
                        zoom: 10,
                    });
                } else {
                    map.setCenter({ lat: currentDay.activities[0]?.coords?.latitude || 40.7580, lng: currentDay.activities[0]?.coords?.longitude || -73.9855 });
                }

                markers.forEach(marker => marker.setMap(null));
                markers = [];

                const pathCoords = [];
                currentDay.activities.forEach(activity => {
                    if (activity.coords) {
                        const position = { lat: activity.coords.latitude, lng: activity.coords.longitude };
                        markers.push(new google.maps.Marker({
                            position: position,
                            map: map,
                            title: activity.description,
                        }));
                        pathCoords.push(position);
                    }
                });

                if (pathCoords.length > 1 && map) {
                    const flightPath = new google.maps.Polyline({
                        path: pathCoords,
                        geodesic: true,
                        strokeColor: COLORS.primary,
                        strokeOpacity: 1.0,
                        strokeWeight: 3,
                    });
                    flightPath.setMap(map);
                }
            } else {
                 mapContainer.innerHTML = `<p style="text-align: center; color: var(--color-light-text); padding: 20px;">מפת גוגל אינה זמינה. אנא ודא שמפתח ה-API תקין ושיש חיבור לאינטרנט.</p>`;
            }

            const recommendationsList = document.getElementById('recommendations-list');
            recommendationsList.innerHTML = '';
            MOCK_RECOMMENDATIONS.forEach(rec => {
                const div = document.createElement('div');
                div.className = 'recommendation-card';
                div.onclick = () => alert(rec.name + `\nסוג: ${rec.type}\nמרחק: ${rec.distance} ק"מ\n\n`);
                div.innerHTML = `
                    <p class="recommendation-name">${rec.name}</p>
                    <p class="recommendation-details">${rec.type} • ${rec.distance} ק"מ</p>
                `;
                recommendationsList.appendChild(div);
            });
        }

        function addItineraryActivity() {
            alert('הוספת פעילות: פונקציונליות זו תפותח לעריכה ישירות על המפה.');
        }

        function getWeatherForLocation(locationName) {
            const mockWeather = {
                'אוגוסטה, מיין': 'מעונן חלקית, 22°C',
                'בר הרבור, מיין': 'שמשי, 20°C',
                'פארק לאומי אקדיה': 'בהיר, 18°C',
                'ניו יורק': 'גשם קל, 25°C',
            };
            return mockWeather[locationName] || 'אין נתוני מזג אוויר';
        }

        // --- Budget Functions ---
        function renderBudget() {
            if (!selectedTrip || !selectedTrip.budget) return;

            const { total, personalTotal, sharedTotal, expenses } = selectedTrip.budget;
            const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const personalExpenses = expenses.filter(exp => exp.type === 'personal').reduce((sum, exp) => sum + exp.amount, 0);
            const sharedExpenses = expenses.filter(exp => exp.type === 'shared').reduce((sum, exp) => sum + exp.amount, 0);
            const remainingBudget = total - totalExpenses;

            document.getElementById('budget-total').textContent = total.toFixed(2);
            document.getElementById('budget-expenses').textContent = totalExpenses.toFixed(2);
            document.getElementById('budget-remaining').textContent = remainingBudget.toFixed(2);
            document.getElementById('budget-personal').textContent = personalTotal.toFixed(2);
            document.getElementById('budget-personal-spent').textContent = personalExpenses.toFixed(2);
            document.getElementById('budget-shared').textContent = sharedTotal.toFixed(2);
            document.getElementById('budget-shared-spent').textContent = sharedExpenses.toFixed(2);

            const expensesList = document.getElementById('expenses-list');
            expensesList.innerHTML = '';
            if (expenses.length === 0) {
                expensesList.innerHTML = `<p class="light-text">עדיין אין הוצאות רשומות.</p>`;
            } else {
                expenses.slice(-5).reverse().forEach(exp => { // Show last 5
                    const div = document.createElement('div');
                    div.className = 'expense-item';
                    div.innerHTML = `
                        <span class="expense-description">${exp.description}</span>
                        <span class="expense-amount">$${exp.amount.toFixed(2)}</span>
                        <span class="expense-category">(${exp.category} - ${exp.type === 'shared' ? 'משותף' : 'אישי'})</span>
                    `;
                    expensesList.appendChild(div);
                });
            }
        }

        function showAddExpenseModal() {
            document.getElementById('add-expense-modal').classList.add('modal-show');
            populateExpenseCategories();
            setNewExpenseType('shared'); // Reset radio button state
        }

        function hideAddExpenseModal() {
            document.getElementById('add-expense-modal').classList.remove('modal-show');
            document.getElementById('new-expense-description').value = '';
            document.getElementById('new-expense-amount').value = '';
            document.getElementById('new-expense-category').value = '';
            document.getElementById('new-category-name').value = '';
            document.getElementById('new-category-input-container').style.display = 'none';
        }

        function populateExpenseCategories() {
            const select = document.getElementById('new-expense-category');
            select.innerHTML = '<option value="">בחר קטגוריה</option>';
            selectedTrip.budget.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
            const addOption = document.createElement('option');
            addOption.value = 'add_new_category';
            addOption.textContent = 'הוסף קטגוריה חדשה...';
            select.appendChild(addOption);

            select.onchange = (event) => {
                if (event.target.value === 'add_new_category') {
                    document.getElementById('new-category-input-container').style.display = 'block';
                } else {
                    document.getElementById('new-category-input-container').style.display = 'none';
                    document.getElementById('new-category-name').value = '';
                }
            };
        }

        function addNewCategory() {
            const newCatName = document.getElementById('new-category-name').value.trim();
            if (!newCatName) {
                alert('יש להזין שם לקטגוריה חדשה.');
                return;
            }
            if (selectedTrip.budget.categories.includes(newCatName)) {
                alert('קטגוריה זו כבר קיימת.');
                return;
            }
            selectedTrip.budget.categories.push(newCatName);
            populateExpenseCategories();
            document.getElementById('new-expense-category').value = newCatName;
            document.getElementById('new-category-input-container').style.display = 'none';
            document.getElementById('new-category-name').value = '';
            alert(`הקטגוריה "${newCatName}" נוספה.`);
            debounceSave();
        }
        
        function setNewExpenseType(type) {
            newExpenseType = type;
            document.querySelectorAll('.radio-container .radio-button').forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.classList.add('radio-button-selected');
                } else {
                    btn.classList.remove('radio-button-selected');
                }
            });
        }


        function addExpense() {
            const description = document.getElementById('new-expense-description').value.trim();
            const amount = parseFloat(document.getElementById('new-expense-amount').value);
            const category = document.getElementById('new-expense-category').value;

            if (!description || isNaN(amount) || amount <= 0 || !category) {
                alert('יש למלא את כל שדות ההוצאה בסכום חוקי.');
                return;
            }

            const newExpense = {
                id: `exp-${Date.now()}`,
                description: description,
                amount: amount,
                category: category,
                type: newExpenseType,
                date: new Date().toISOString(),
                payer: userId,
            };

            selectedTrip.budget.expenses.push(newExpense);
            hideAddExpenseModal();
            renderBudget();
            debounceSave();
        }

        // --- Packing List Functions ---
        function renderPackingList() {
            if (!selectedTrip || !selectedTrip.packingList) return;

            const packingListDiv = document.getElementById('packing-list');
            packingListDiv.innerHTML = '';
            if (selectedTrip.packingList.length === 0) {
                packingListDiv.innerHTML = `<p class="light-text">הרשימה ריקה. הוסף פריטים!</p>`;
            } else {
                selectedTrip.packingList.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'packing-item';
                    div.innerHTML = `
                        <input type="checkbox" id="pack-item-${item.id}" ${item.packed ? 'checked' : ''}>
                        <label for="pack-item-${item.id}" class="packing-item-text ${item.packed ? 'packing-item-text-packed' : ''}">${item.item}</label>
                    `;
                    div.querySelector('input[type="checkbox"]').onchange = (event) => {
                        item.packed = event.target.checked;
                        event.target.nextElementSibling.classList.toggle('packing-item-text-packed', item.packed);
                        debounceSave();
                    };
                    packingListDiv.appendChild(div);
                });
            }
        }

        function showAddPackingItemModal() {
            document.getElementById('add-packing-item-modal').classList.add('modal-show');
            document.getElementById('new-packing-item').value = '';
        }

        function hideAddPackingItemModal() {
            document.getElementById('add-packing-item-modal').classList.remove('modal-show');
        }

        function addPackingItem() {
            const itemName = document.getElementById('new-packing-item').value.trim();
            if (!itemName) {
                alert('יש להזין פריט לרשימה.');
                return;
            }
            selectedTrip.packingList.push({ id: `pack-${Date.now()}`, item: itemName, packed: false });
            hideAddPackingItemModal();
            renderPackingList();
            debounceSave();
        }

        // --- Debts Functions ---
        function renderDebts() {
            if (!selectedTrip || !selectedTrip.debts) return;

            const debtsListDiv = document.getElementById('debts-list');
            debtsListDiv.innerHTML = '';
            if (selectedTrip.debts.length === 0) {
                debtsListDiv.innerHTML = `<p class="light-text">אין חובות רשומים כרגע.</p>`;
            } else {
                selectedTrip.debts.forEach(debt => {
                    const div = document.createElement('div');
                    div.className = 'debt-item';
                    div.innerHTML = `
                        <span class="debt-description">${debt.description} (${debt.friend})</span>
                        <span class="debt-amount">$${debt.amount.toFixed(2)}</span>
                        <button class="debt-status-button ${debt.settled ? 'debt-status-button-settled' : ''}" data-debt-id="${debt.id}">
                            <span class="debt-status-button-text">${debt.settled ? 'שולם' : 'טרם שולם'}</span>
                        </button>
                    `;
                    div.querySelector('button').onclick = (event) => {
                        toggleDebtSettled(event.target.dataset.debtId || event.target.closest('button').dataset.debtId);
                    };
                    debtsListDiv.appendChild(div);
                });
            }
        }

        function showAddDebtModal() {
            document.getElementById('add-debt-modal').classList.add('modal-show');
            document.getElementById('new-debt-description').value = '';
            document.getElementById('new-debt-amount').value = '';
            document.getElementById('new-debt-friend').value = '';
        }

        function hideAddDebtModal() {
            document.getElementById('add-debt-modal').classList.remove('modal-show');
        }

        function addDebt() {
            const description = document.getElementById('new-debt-description').value.trim();
            const amount = parseFloat(document.getElementById('new-debt-amount').value);
            const friend = document.getElementById('new-debt-friend').value.trim();

            if (!description || isNaN(amount) || amount <= 0 || !friend) {
                alert('יש למלא את כל שדות החוב בסכום חוקי.');
                return;
            }

            selectedTrip.debts.push({ id: `debt-${Date.now()}`, description, amount, friend, date: new Date().toISOString(), settled: false });
            hideAddDebtModal();
            renderDebts();
            debounceSave();
        }

        function toggleDebtSettled(debtId) {
            const debt = selectedTrip.debts.find(d => d.id === debtId);
            if (debt) {
                debt.settled = !debt.settled;
                renderDebts();
                debounceSave();
            }
        }

        // --- New Trip Functions ---
        function showNewTripModal() {
            document.getElementById('new-trip-modal').classList.add('modal-show');
            document.getElementById('new-trip-name').value = '';
            document.getElementById('new-trip-dates').value = '';
            document.getElementById('new-trip-budget-total').value = '';
        }

        function hideNewTripModal() {
            document.getElementById('new-trip-modal').classList.remove('modal-show');
        }

        function addNewTrip() {
            const name = document.getElementById('new-trip-name').value.trim();
            const dates = document.getElementById('new-trip-dates').value.trim();
            const budgetTotal = parseFloat(document.getElementById('new-trip-budget-total').value);

            if (!name || !dates || isNaN(budgetTotal) || budgetTotal <= 0) {
                alert('יש למלא את כל שדות הטיול החדש בסכום חוקי.');
                return;
            }

            const newTrip = {
                id: `trip-${Date.now()}`,
                name: name,
                dates: dates,
                budget: {
                    total: budgetTotal,
                    personalTotal: budgetTotal / 3, // Assuming 3 friends for initial split
                    sharedTotal: budgetTotal * 2 / 3,
                    expenses: [],
                    categories: ['לינה', 'תחבורה', 'אוכל', 'אטרקציות', 'קניות', 'שונות'],
                },
                packingList: [
                    { id: 'pack-auto-1', item: 'דרכון', packed: false },
                    { id: 'pack-auto-2', item: 'כרטיסי טיסה', packed: false },
                    { id: 'pack-auto-3', item: 'מטען נייד', packed: false },
                    { id: 'pack-auto-4', item: 'כבל טעינה', packed: false },
                    { id: 'pack-auto-5', item: 'ראש טעינה אוניברסלי', packed: false },
                    { id: 'pack-auto-6', item: 'דוחה יתושים', packed: false },
                    { id: 'pack-auto-7', item: 'בגדים לטיול (לפי ימים)', packed: false },
                    { id: 'pack-auto-8', item: 'נעלי הליכה נוחות', packed: false },
                    { id: 'pack-auto-9', item: 'משקפי שמש', packed: false },
                    { id: 'pack-auto-10', item: 'קרם הגנה', packed: false },
                    { id: 'pack-auto-11', item: 'תרופות אישיות', packed: false },
                    { id: 'pack-auto-12', item: 'מתאם לשקע אמריקאי', packed: false },
                ],
                debts: [],
                itinerary: [],
            };

            currentTrips.push(newTrip);
            selectedTrip = newTrip;
            hideNewTripModal();
            updateTripPicker();
            showMainAppContent();
            alert(`הטיול "${newTrip.name}" נוסף בהצלחה!`);
            debounceSave();
        }

        // --- Helper for Google Maps API loading ---
        window.initMap = function() {
            console.log("Google Maps API callback triggered.");
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                if (document.getElementById('itinerary-screen').style.display === 'block') {
                    renderItinerary();
                }
            } else {
                document.addEventListener('DOMContentLoaded', () => {
                    if (document.getElementById('itinerary-screen').style.display === 'block') {
                        renderItinerary();
                    }
                });
            }
        };

        // Initially render itinerary screen and activate its button
        navigateTo('itinerary');


    </script>
</body>
</html>
